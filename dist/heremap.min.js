!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).heremap=f()}}(function(){return function(){return function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){return o(e[i][1][r]||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}}()({"/heremap.js":[function(require,module,exports){(function(process){"use strict";let modules={};Object.assign(modules,require("./common.js")),Object.assign(modules,require("./geometry.js")),Object.assign(modules,require("./routing.js")),Object.assign(modules,require("./geocoding.js")),Object.assign(modules,require("./place.js")),process.browser&&(Object.assign(modules,require("./map.js")),Object.assign(modules,require("./cluster.js")),Object.assign(modules,require("./touch.js"))),module.exports=modules}).call(this,require("_process"))},{"./cluster.js":2,"./common.js":3,"./geocoding.js":4,"./geometry.js":5,"./map.js":6,"./place.js":15,"./routing.js":16,"./touch.js":17,_process:1}],1:[function(require,module,exports){var cachedSetTimeout,cachedClearTimeout,process=module.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,function(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},{}],2:[function(require,module,exports){"use strict";const cm=require("./common.js"),m=require("./map.js");let map=null,clusterLayer=null,_visible=!1,iconNoise=null,clusterStyle=[],clusteredDataProvider=null;function getClusterPresentation(cluster){let data={isCluster:()=>!0},weight=cluster.getWeight();data.getWeight=(()=>weight);let icon=function(imgData,text){const canvas=document.createElement("canvas");canvas.width=imgData.width,canvas.height=imgData.height;let ctx=canvas.getContext("2d");return ctx.font="bold 12px Arial",ctx.fillStyle="white",ctx.textAlign="center",ctx.putImageData(imgData,0,0),ctx.fillText(text,canvas.width/2,(canvas.height+12)/2-2),new H.map.Icon(canvas,{anchor:{x:canvas.width/2,y:canvas.height/2}})}(clusterStyle.find(elt=>weight>=elt.weight).imageData,""+weight),min=cluster.getMinZoom(),max=cluster.getMaxZoom(),clusterMarker=new H.map.Marker(cluster.getPosition(),{min:min,max:max,icon:icon});return clusterMarker.setData(data),clusterMarker}function getNoisePresentation(noisePoint){const data={getData:()=>noisePoint.getData(),isCluster:()=>!1,getWeight:()=>1};var noiseMarker=new H.map.Marker(noisePoint.getPosition(),{min:noisePoint.getMinZoom(),icon:iconNoise});return noiseMarker.setData(data),noiseMarker}module.exports={cluster:async function(coords,opt,cb=null){let dataPoints=[];map=m.getMap();let _home=cm.getHome(),settings={eps:64,minZoom:1,maxZoom:24,noise:{icon:_home+"svg/bluedot.svg",size:16},cluster:{200:{icon:_home+"svg/cluster_red.svg",color:"#B50015",size:64},75:{icon:_home+"svg/cluster_orange.svg",color:"#FF6900",size:48},2:{icon:_home+"svg/cluster_green.svg",color:"#7BD30A",size:40}}};opt&&Object.assign(settings,opt);let useTheme=!0;opt&&(!opt||opt.noise||opt.cluster)||(useTheme=!1),coords.forEach(coord=>{let dp=new H.clustering.DataPoint(coord[0],coord[1],1,coord);dataPoints.push(dp)});let minWeight=2;if(useTheme){let icon=settings.noise.icon;"@"==icon[0]&&(icon=cm.getHome()+icon.substr(1));let iconOpt=null;settings.noise.size&&(iconOpt={size:{w:settings.noise.size,h:settings.noise.size}}),iconNoise=new H.map.Icon(icon,iconOpt);let weightOrder=Object.keys(settings.cluster).sort(function(a,b){return b-a});minWeight=weightOrder[weightOrder.length-1];let promises=[];clusterStyle=weightOrder.map(weight=>{let size=settings.cluster[weight].size,icon=settings.cluster[weight].icon;"@"==icon[0]&&(icon=cm.getHome()+icon.substr(1));let p=function(file,width=null,height=null){return new Promise(resolve=>{var newImg=new Image;newImg.onload=function(){let width=newImg.width,height=newImg.height,src=document.createElement("canvas");src.width=width,src.height=height;let ctx=src.getContext("2d");ctx.drawImage(newImg,0,0,width,height);let imageData=ctx.getImageData(0,0,width,height);resolve(imageData)},newImg.crossOrigin="Anonymous",width&&(newImg.width=width),height&&(newImg.height=height),newImg.src=file})}(icon,size,size);return promises.push(p),{weight:parseInt(weight),icon:icon}}),(await Promise.all(promises)).forEach((imageData,i)=>{clusterStyle[i].imageData=imageData})}let optProvider={clusteringOptions:{eps:settings.eps,minWeight:minWeight},min:settings.minZoom,max:settings.maxZoom};return useTheme&&(optProvider.theme={getClusterPresentation:getClusterPresentation,getNoisePresentation:getNoisePresentation}),clusteredDataProvider=new H.clustering.Provider(dataPoints,optProvider),clusterLayer=new H.map.layer.ObjectLayer(clusteredDataProvider),map.addLayer(clusterLayer),_visible=!0,cb&&clusteredDataProvider.addEventListener("tap",function(ev){let data=ev.target.getData(),coord=map.screenToGeo(ev.currentPointer.viewportX,ev.currentPointer.viewportY);if(data.isCluster()){let weigth=data.getWeight();cb(ev,m.coordO2A(coord),null,weigth)}else{let userData=data.getData();cb(ev,m.coordO2A(coord),userData[2],1)}}),clusterLayer},clusterShow:function(){!_visible&&clusterLayer&&(map.addLayer(clusterLayer),_visible=!0)},clusterHide:function(){_visible&&clusterLayer&&(map.removeLayer(clusterLayer),_visible=!1)}}},{"./common.js":3,"./map.js":6}],3:[function(require,module,exports){(function(process){"use strict";const request=require("superagent");let APP_ID=process.env.APP_ID,APP_CODE=process.env.APP_CODE,CIT="",PROTOCOL="https:",_useHTTPS=!0,_home=".";if(process.browser){let _script=document.getElementsByTagName("script"),_file=_script[_script.length-1].src,_path=_file.substring(0,_file.lastIndexOf("/")),pos=_path.indexOf("heremap");_home=_path.substring(0,pos+"heremap".length)+"/"}module.exports={config:function(opt){opt.app_id&&(APP_ID=opt.app_id),opt.app_code&&(APP_CODE=opt.app_code),opt.useCIT&&(CIT=".cit"),opt.useHTTP&&(PROTOCOL="http:",_useHTTPS=!1),opt.useHTTPS&&(PROTOCOL="https:",_useHTTPS=!0)},buildUrl:function(base,endpoint){return PROTOCOL+"//"+base+CIT+"."+endpoint},getAppId:function(){return APP_ID},getAppCode:function(){return APP_CODE},getCIT:function(){return CIT},getProtocol:function(){return PROTOCOL},getHome:function(){return _home},useHTTPS:function(){return _useHTTPS},addCredentials:function(...obj){return Object.assign({app_id:APP_ID,app_code:APP_CODE},...obj)},hereRest:async function(url,settings,mode="get",needresp="true"){let p=request.get(url);return"post"==mode&&(p=request.post(url)),p.query(settings).then(res=>{if("200"!=res.status)throw new Error("Error "+res.status+":"+res.body);if(needresp&&!res.body.Response&&!res.body.response)throw console.error(res.body),new Error("Query error:"+res.body);if(res.body.response&&"ApplicationError"==res.body.response.type)throw console.error(res.body),new Error("Error"+res.body.response.details);return res})}}}).call(this,require("_process"))},{_process:1,superagent:10}],4:[function(require,module,exports){"use strict";const cm=require("./common.js");module.exports={geocode:function(address){const settings=cm.addCredentials({searchText:address}),url=cm.buildUrl("geocoder","api.here.com/6.2/geocode.json");return cm.hereRest(url,settings).then(res=>{if(0==res.body.Response.View.length)throw new Error("Geocode Address not found: "+address);var location=res.body.Response.View[0].Result[0].Location;return{coord:[location.NavigationPosition[0].Latitude,location.NavigationPosition[0].Longitude],body:res.body}})},reverseGeocode:function(coord){const settings=cm.addCredentials({mode:"retrieveAddresses",prox:coord[0]+","+coord[1]}),url=cm.buildUrl("reverse.geocoder","api.here.com/6.2/reversegeocode.json");return cm.hereRest(url,settings).then(res=>{var location=res.body.Response.View[0].Result[0].Location;return{location:location,address:location.Address,body:res.body}})}}},{"./common.js":3}],5:[function(require,module,exports){const simplifyJs=require("simplify-js");function coords2XY(coords){return coords.map(coord=>({x:coord[1],y:coord[0]}))}function xy2Coords(xys){return xys.map(xy=>[xy.y,xy.x])}module.exports={coordO2A:function(obj){return[obj.lat,obj.lng]},coordA2O:function(arr){return{lat:arr[0],lng:arr[1]}},coords2XY:coords2XY,xy2Coords:xy2Coords,coord2Point:function(coord){return{lat:coord[0],lng:coord[1]}},point2Coord:function(point){return[point.lat,point.lng]},simplify:function(coords,tolerance,highacc=!1){let xy=coords2XY(coords),simplified=simplifyJs(xy,tolerance,highacc);return simplified.length<1?coords:xy2Coords(simplified)}}},{"simplify-js":8}],6:[function(require,module,exports){"use strict";const cm=require("./common.js"),g=require("./geometry.js");let _platform=null,_provider=null,_defaultLayers=null,_ui=null,_map=null,_behavior=null,group=null,_layers=[],_key={},_bubbleMarker=null,_scheme="normal.day.grey",_locateMe=null,_htmlItem=null,_htmlItemId=null;function layerCreate(name,visible){return(group=new H.map.Group).name=name,_map.addObject(group),_layers.push(group),void 0!==visible&&group.setVisibility(visible),group}function layerDelete(name){let layer=layerFind(name);layer&&(_map.removeObject(layer),_layers=_layers.filter(item=>item.name!==name))}function layerEmpty(name){let layer=layerFind(name);layer?layer.removeAll():layerCreate(name)}function layerFind(name){let l=_layers.find(layer=>layer.name==name);return void 0===l?null:l}function bubbleUnique(coord,txt){_bubbleMarker?(_bubbleMarker.setPosition(g.coordA2O(coord)),_bubbleMarker.setContent(txt),_bubbleMarker.open()):(_bubbleMarker=new H.ui.InfoBubble(g.coordA2O(coord),{content:txt}),_ui.addBubble(_bubbleMarker),_bubbleMarker.addClass("bubbleUnique"))}async function buildIcon(opt){let icon,iconSrc,settings={img:null,svg:null,opt:null};if(Object.assign(settings,opt),!settings.img&&!settings.svg)return null;if(settings.img)iconSrc="@"==settings.img[0]?cm.getHome()+settings.img.substr(1):settings.img;else if(settings.svg){let url=null;iconSrc=settings.svg,(url="@"==settings.svg[0]?cm.getHome()+settings.svg.substr(1):"<svg"==settings.svg.substr(0,4)?null:settings.svg)&&(iconSrc=await fetch(url).then(res=>200!=res.status?null:res.text()))}let iconOpt={crossOrigin:!0};if(settings.opt&&settings.opt.size){let w,h;"number"==typeof settings.opt.size?w=h=settings.opt.size:[w,h]=settings.opt.size.split("x"),iconOpt.size={w:w,h:h}}function _getsizeSvg(iconSrc){let match,w=null,h=null,r=/width="(\d+)"/;return(match=iconSrc.match(r))&&(w=match[1]),r=/height="(\d+)"/,(match=iconSrc.match(r))&&(h=match[1]),[w,h]}if(settings.svg&&settings.opt&&settings.opt.ratio){let w=null,h=null;[w,h]=_getsizeSvg(iconSrc),iconOpt.size={w:Math.floor(w*settings.opt.ratio),h:Math.floor(h*settings.opt.ratio)}}if(settings.opt&&settings.opt.anchor){let x=null,y=null;if("number"==typeof settings.opt.anchor?x=y=settings.opt.anchor:"center"==settings.opt.anchor&&settings.svg?([x,y]=_getsizeSvg(iconSrc),x/=2,y/=2):[x,y]=settings.opt.anchor.split("x"),!x||!y){throw new Error("BuildIcon: incorrect anchor")}iconOpt.anchor={x:x,y:y}}if(settings.opt)for(let name in settings.opt){if("file"==name||"size"==name||"anchor"==name)continue;let re=new RegExp("{"+name+"}","g");iconSrc=iconSrc.replace(re,settings.opt[name])}return icon=new H.map.Icon(iconSrc,iconOpt)}async function marker(opt){let settings={layer:"default",coord:null,img:null,svg:null,icon:null,opt:{},pointerEnter:null,pointerClick:null,data:null,bubble:!1,draggable:!1,dragged:null};Array.isArray(opt)&&(opt.coord=opt),Object.assign(settings,opt);let layer=layerFind(settings.layer);if(!layer){throw new Error("layer not found:"+settings.layer)}settings.coord={lat:settings.coord[0],lng:settings.coord[1]},settings.color&&(settings.opt.color=settings.color),settings.size&&(settings.opt.size=settings.size),settings.ratio&&(settings.opt.ratio=settings.ratio),settings.anchor&&(settings.opt.anchor=settings.anchor);let markerOpt=null;if(settings.img||settings.svg){markerOpt={icon:await buildIcon(settings)}}else settings.icon&&(markerOpt={icon:settings.icon});let marker=new H.map.Marker(settings.coord,markerOpt);if(marker.draggable=settings.draggable,settings.droppable&&(marker.draggable=!0,marker.droppable=!0),settings.dragged&&(marker.dragged=settings.dragged),settings.data){let data=settings.data;if("__OPT__"==settings.data){delete(data=settings).coord;for(let p in data)data[p]||delete data[p];data=JSON.stringify(data,null,2).replace(/\n/g,"<br/>")}marker.setData(data)}return settings.pointerEnter&&marker.addEventListener("pointerenter",function(ev){let target=ev.target,coord=_map.screenToGeo(ev.currentPointer.viewportX,ev.currentPointer.viewportY);settings.pointerEnter(target,g.coordO2A(coord),ev)}),settings.pointerClick&&marker.addEventListener("tap",function(ev){let target=ev.target,coord=_map.screenToGeo(ev.currentPointer.viewportX,ev.currentPointer.viewportY);settings.pointerClick(target,g.coordO2A(coord),ev)}),settings.droppable&&(marker.addEventListener("dragstart",function(ev){let offset=htmlBounding(),screen={left:ev.currentPointer.viewportX+offset.left,top:ev.currentPointer.viewportY+offset.top};settings.droppable(screen,ev,ev.type)}),marker.addEventListener("drag",function(ev){let offset=htmlBounding(),screen={left:ev.currentPointer.viewportX+offset.left,top:ev.currentPointer.viewportY+offset.top};settings.droppable(screen,ev,ev.type)}),marker.addEventListener("dragend",function(ev){let offset=htmlBounding(),screen={left:ev.currentPointer.viewportX+offset.left,top:ev.currentPointer.viewportY+offset.top};settings.droppable(screen,ev,ev.type)})),settings.bubble&&marker.addEventListener("tap",function(ev){let data=ev.target.getData(),coord=_map.screenToGeo(ev.currentPointer.viewportX,ev.currentPointer.viewportY);bubbleUnique(g.coordO2A(coord),data)}),settings.zIndex&&marker.setZIndex(settings.zIndex),layer.addObject(marker),marker}function polyline(opt){let settings={layer:"default",coords:null,style:{lineWidth:4,strokeColor:"rgba(0, 128, 255, 0.7)"},arrows:null,data:null,z:null,pointerClick:null,pointerEnter:null,pointerLeave:null};Array.isArray(opt)&&(opt={coords:opt}),Object.assign(settings,opt);let layer=layerFind(settings.layer);if(!layer){throw new Error("layer not found:"+settings.layer)}if(!settings.coords){throw new Error("Polyline: coords not found:")}let strip=new H.geo.Strip;settings.coords.forEach(function(point){strip.pushLatLngAlt(point[0],point[1])});let polyline=new H.map.Polyline(strip,{style:settings.style,data:settings.data,arrows:settings.arrows});return settings.z&&polyline.setZIndex(settings.z),settings.data&&polyline.setData(settings.data),settings.pointerEnter&&polyline.addEventListener("pointerenter",function(ev){let target=ev.target,coord=_map.screenToGeo(ev.currentPointer.viewportX,ev.currentPointer.viewportY);settings.pointerEnter(target,g.coordO2A(coord),ev)}),settings.pointerLeave&&polyline.addEventListener("pointerleave",function(ev){let target=ev.target,coord=_map.screenToGeo(ev.currentPointer.viewportX,ev.currentPointer.viewportY);settings.pointerLeave(target,g.coordO2A(coord),ev)}),settings.pointerClick&&polyline.addEventListener("tap",function(ev){let target=ev.target,coord=_map.screenToGeo(ev.currentPointer.viewportX,ev.currentPointer.viewportY);settings.pointerClick(target,g.coordO2A(coord),ev)}),layer.addObject(polyline),polyline}function circle(opt){let settings={layer:"default",coord:null,radius:100,style:{strokeColor:"rgba(55, 85, 170, 0.2)",lineWidth:2,fillColor:"rgba(0, 128, 0, 0.1)"}};Object.assign(settings,opt);let layer=layerFind(settings.layer);if(!layer){throw new Error("layer not found:"+settings.layer)}let circle=new H.map.Circle(g.coordA2O(settings.coord),settings.radius,{style:settings.style});return layer.addObject(circle),circle}function htmlBounding(){let bb=_htmlItemId.getBoundingClientRect();return{top:bb.top+window.pageYOffset,left:bb.left+window.pageXOffset,width:bb.width,height:bb.height}}H.map.Marker.prototype.getCoord=function(){let pos=this.getPosition();return g.point2Coord(pos)},module.exports={getMap:function(){return _map},getUI:function(){return _ui},getBehavior:function(){return _behavior},getMapHtmlItem:function(){return _htmlItem},map:function(htmlItem,opt){_htmlItem=htmlItem,_htmlItemId=document.getElementById(htmlItem);let settings={zoom:10,center:[48.86,2.3],clickLeft:null,clickRight:null,keyDown:null,click:null,dbClick:null,viewChange:null,render:null,loadTile:null},mps=1,app_id=cm.getAppId(),app_code=cm.getAppCode();if(!app_id||!app_code)return void(_htmlItemId.innerHTML="app_id/app_code not initialised");_platform=new H.service.Platform({app_id:app_id,app_code:app_code,useCIT:cm.getCIT(),useHTTPS:cm.useHTTPS()}),Object.assign(settings,opt),settings.scheme&&(_scheme=settings.scheme),1==new URLSearchParams(window.location.search).get("demotest")&&(_scheme="white"),_defaultLayers=_platform.createDefaultLayers(),_provider=new H.map.provider.ImageTileProvider({label:"Base Provider",descr:"",min:0,max:20,crossOrigin:"anonymous",getURL:function(col,row,level){++mps>4&&(mps=1);let url=[cm.getProtocol(),"//",mps,".base.maps"+cm.getCIT()+".api.here.com/maptile/","2.1","/","maptile","/","newest","/",_scheme,"/",level,"/",col,"/",row,"/","256","/","png","?lg=","FRE","&app_code=",app_code,"&app_id=",app_id].join("");return"japan"==_scheme?url=[cm.getProtocol(),"//","m.lbs"+cm.getCIT()+".api.heremaps.jp/v1/map?app_id=",APP_ID_JAPAN,"&app_code=",APP_CODE_JAPAN,"&tilematrix=EPSG:900913:",level,"&tilecol=",col,"&tilerow=",row].join(""):"korea"==_scheme?url=[cm.getProtocol(),"//","3.base.maps"+cm.getCIT()+".api.heremaps.kr/maptile/2.1/maptile/34439348c3/normal.day/","/",level,"/",col,"/",row,"/","256","/","png","?lg=","FRE","&app_code=",APP_CODE_KOREA,"&app_id=",APP_ID_KOREA].join(""):"black"==_scheme?url=cm.getHome()+"png/black.png":"white"==_scheme?url=cm.getHome()+"png/white.png":"transparent"==_scheme&&(url=cm.getHome()+"png/transparent.png"),settings.loadTile&&settings.loadTile(level,col,row,url),url}});let __layer=new H.map.layer.TileLayer(_provider);_map=new H.Map(document.getElementById(htmlItem),__layer,{center:g.coordA2O(settings.center),zoom:settings.zoom}),_behavior=new H.mapevents.Behavior(new H.mapevents.MapEvents(_map)),_ui=H.ui.UI.createDefault(_map,_defaultLayers),layerCreate("default"),settings.viewChange&&_map.addEventListener("mapviewchangeend",function(){let bound=_map.getViewBounds(),lat=(bound.ka+bound.ja)/2,lng=(bound.ga+bound.ha)/2;settings.viewChange(_map.getZoom(),[lat,lng])});let kup=function(){_key.ctrl=!1,_key.shift=!1,_key.alt=!1,_key.key=""},kdown=function(e){_key.ctrl="Control"==e.key||"Control"==e.keyIdentifier||1==e.ctrlKey,_key.shift="Shift"==e.key||"Shift"==e.keyIdentifier||1==e.shiftKey,_key.alt="Alt"==e.key||"Alt"==e.keyIdentifier||1==e.shiftKey,_key.key=e.key,settings.keyDown&&settings.keyDown(_key)};return _map.addEventListener("mouseenter",function(){document.addEventListener("keydown",kdown),document.addEventListener("keyup",kup)}),_map.addEventListener("pointerenter",function(){document.addEventListener("keydown",kdown),document.addEventListener("keyup",kup)}),_map.addEventListener("mouseleave",function(){document.removeEventListener("keydown",kdown),document.removeEventListener("keyup",kup)}),_map.addEventListener("dbltap",function(ev){if(ev.target instanceof H.map.Marker)return;let coord=_map.screenToGeo(ev.currentPointer.viewportX,ev.currentPointer.viewportY),button=ev.currentPointer.button;if(settings.dbClick)switch(button){case 0:settings.dbClick(g.coordO2A(coord),"left",_key);break;case 2:settings.dbClick(g.coordO2A(coord),"right",_key)}}),_map.addEventListener("tap",function(ev){if(ev.target instanceof H.map.Marker)return;let coord=_map.screenToGeo(ev.currentPointer.viewportX,ev.currentPointer.viewportY),button=ev.currentPointer.button;if(0==button&&settings.clickLeft&&settings.clickLeft(g.coordO2A(coord),"left",_key),2==button&&settings.clickRight&&settings.clickRight(g.coordO2A(coord),"right",_key),settings.click)switch(button){case 0:settings.click(g.coordO2A(coord),"left",_key);break;case 2:settings.click(g.coordO2A(coord),"right",_key)}}),_map.addEventListener("dragstart",function(ev){let target=ev.target;(target instanceof H.map.Marker||target instanceof H.map.DomMarker)&&_behavior.disable()},!1),_map.addEventListener("dragend",function(ev){let target=ev.target;if(target instanceof mapsjs.map.Marker||target instanceof mapsjs.map.DomMarker){if(_behavior.enable(),target.droppable)return;if(target.dragged){let coord=_map.screenToGeo(ev.currentPointer.viewportX,ev.currentPointer.viewportY);target.dragged(target,g.coordO2A(coord))}}else settings.drag&&settings.drag("dragend")},!1),_map.addEventListener("drag",function(ev){let target=ev.target,pointer=ev.currentPointer;if(target instanceof mapsjs.map.Marker||target instanceof mapsjs.map.DomMarker){if(target.droppable)return;target.setPosition(_map.screenToGeo(pointer.viewportX,pointer.viewportY))}else settings.drag&&settings.drag("drag")},!1),window.addEventListener("resize",function(){_map.getViewPort().resize()}),settings.rendered&&_map.getEngine().addEventListener("render",ev=>{_map.getEngine()===ev.target&&settings.rendered(ev)}),_map},buildIcon:buildIcon,marker:marker,getAvailableMapStyle:function(){const settings=cm.addCredentials({output:"json"}),url=cm.buildUrl("1.base.maps","api.here.com/maptile/2.1/info");return cm.hereRest(url,settings).then(res=>res.body.response)},setScheme:function(scheme){_scheme=scheme},layerCreate:layerCreate,layerFind:layerFind,layerDelete:layerDelete,layerSetVisibility:function(name,visible){let layer=layerFind(name);layer&&layer.setVisibility(visible)},layerEmpty:layerEmpty,bubbleUnique:bubbleUnique,bubbleUniqueHide:function(){_bubbleMarker&&_bubbleMarker.close()},circle:circle,polyline:polyline,polygon:function(opt){let settings={layer:"default",coords:"",style:{lineWidth:4,strokeColor:"rgba(0, 128, 255, 0.7)",fillColor:"rgba(0, 128, 255, 0.7)"},styleHover:null,arrows:null,data:null,z:null,pointerClick:null,pointerEnter:null,pointerLeave:null};Array.isArray(opt)&&(opt={coords:opt}),Object.assign(settings,opt);let layer=layerFind(settings.layer);if(!layer)throw new Error("layer not found:"+settings.layer);if(!settings.coords)throw new Error("Polyline: coords not found:");let strip=new H.geo.Strip;settings.coords.forEach(function(point){strip.pushLatLngAlt(point[0],point[1])});let polygon=new H.map.Polygon(strip,{style:settings.style,data:settings.data,arrows:settings.arrows});return settings.data&&polygon.setData(settings.data),settings.z&&polyline.setZIndex(settings.z),settings.styleHover&&(polygon.addEventListener("pointerenter",function(ev){ev.target.setStyle(settings.styleHover)}),polygon.addEventListener("pointerleave",function(ev){ev.target.setStyle(settings.style)})),settings.pointerEnter&&polygon.addEventListener("pointerenter",function(ev){let target=ev.target,data=target.getData(),coord=_map.screenToGeo(ev.currentPointer.viewportX,ev.currentPointer.viewportY);settings.pointerEnter(target,g.coordO2A(coord),ev,data)}),settings.pointerLeave&&polygon.addEventListener("pointerleave",function(ev){let target=ev.target,data=target.getData(),coord=_map.screenToGeo(ev.currentPointer.viewportX,ev.currentPointer.viewportY);settings.pointerLeave(target,g.coordO2A(coord),ev,data)}),settings.pointerClick&&polygon.addEventListener("tap",function(ev){let target=ev.target,data=target.getData(),coord=_map.screenToGeo(ev.currentPointer.viewportX,ev.currentPointer.viewportY);settings.pointerClick(target,g.coordO2A(coord),ev,data)}),layer.addObject(polygon),polygon},getCenter:function(){let bound=_map.getViewBounds(),lng=(bound.ga+bound.ha)/2;return[(bound.ka+bound.ja)/2,lng]},setCenter:function(coord){_map.setCenter(g.coordA2O(coord))},getZoom:function(){return _map.getZoom()},setZoom:function(zoom){_map.setZoom(zoom)},getViewBB:function(){let bb=_map.getViewBounds();return{latm:bb.ja,latM:bb.ka,lngm:bb.ga,lngM:bb.ha}},setViewBB:function(opt){"string"==typeof opt&&(opt={layer:opt});let bbox,settings={layer:null,pois:null};if(Object.assign(settings,opt),settings.layer){let layer=layerFind(settings.layer);if(!layer)return;let bb=layer.getBounds();if(!bb)return;bb.latm=bb.ja,bb.latM=bb.ka,bb.lngm=bb.ga,bb.lngM=bb.ha;let dx=bb.lngM-bb.lngm,dy=bb.latM-bb.latm;dx/=5,dy/=5,bb.latM+=dy,bb.lngm-=dx,bb.latm-=dy,bb.lngM+=dx,bbox=new H.geo.Rect(bb.latM,bb.lngm,bb.latm,bb.lngM),_map.setViewBounds(bbox,!0)}else if(settings.pois){let bb={latM:0,lngm:180,latm:90,lngM:-180};settings.pois.forEach(poi=>{poi[0]>bb.latM&&(bb.latM=poi[0]),poi[1]>bb.lngM&&(bb.lngM=poi[1]),poi[0]<bb.latm&&(bb.latm=poi[0]),poi[1]<bb.lngm&&(bb.lngm=poi[1])}),bbox=new H.geo.Rect(bb.latM,bb.lngm,bb.latm,bb.lngM),_map.setViewBounds(bbox,!0)}},locateMe:async function(callback,opt){if(!navigator.geolocation)throw new Error("no HTML5 geolocation capabilities");{if(!callback&&_locateMe)return navigator.geolocation.clearWatch(_locateMe),_locateMe=null,void layerDelete("_gps");let settings={position:{svg:"@svg/target.svg",color:"black",anchor:"center"},accuracy:{strokeColor:"rgba(0, 128, 0, 0.8)",lineWidth:2,fillColor:"rgba(0, 128, 0, 0.4)"}};Object.assign(settings,opt);let iconCrossHair=await buildIcon({svg:settings.position.svg,img:settings.position.img,opt:settings.position});_locateMe=navigator.geolocation.watchPosition(position=>{let gps=[position.coords.latitude,position.coords.longitude];layerEmpty("_gps"),circle({layer:"_gps",coord:gps,radius:position.coords.accuracy,style:settings.accuracy}),marker({layer:"_gps",coord:gps,icon:iconCrossHair}),callback(gps,position.coords.accuracy)},error=>{let msg="";switch(error.code){case error.PERMISSION_DENIED:msg+="User denied the request for Geolocation.";break;case error.POSITION_UNAVAILABLE:msg+="Location information is unavailable.";break;case error.TIMEOUT:msg+="timed out.";break;case error.UNKNOWN_ERROR:msg+="An unknown error occurred."}throw new Error("HTML5 location error:"+msg)},{enableHighAccuracy:!0})}},screenshot:function(opt){let para=null;return opt&&opt.ui&&(para=[_ui]),new Promise((resolve,reject)=>{_map.capture(function(canvas){if(!canvas)return reject("Map screenshot not supported");let dataURL=canvas.toDataURL();if(opt&&opt.name){let a=document.createElement("a");a.href=dataURL,a.target="_blank",a.download=opt.name,document.body.appendChild(a),a.click()}resolve(dataURL)},para)})},htmlBounding:htmlBounding}},{"./common.js":3,"./geometry.js":5}],7:[function(require,module,exports){function Emitter(obj){if(obj)return function(obj){for(var key in Emitter.prototype)obj[key]=Emitter.prototype[key];return obj}(obj)}void 0!==module&&(module.exports=Emitter),Emitter.prototype.on=Emitter.prototype.addEventListener=function(event,fn){return this._callbacks=this._callbacks||{},(this._callbacks["$"+event]=this._callbacks["$"+event]||[]).push(fn),this},Emitter.prototype.once=function(event,fn){function on(){this.off(event,on),fn.apply(this,arguments)}return on.fn=fn,this.on(event,on),this},Emitter.prototype.off=Emitter.prototype.removeListener=Emitter.prototype.removeAllListeners=Emitter.prototype.removeEventListener=function(event,fn){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var cb,callbacks=this._callbacks["$"+event];if(!callbacks)return this;if(1==arguments.length)return delete this._callbacks["$"+event],this;for(var i=0;i<callbacks.length;i++)if((cb=callbacks[i])===fn||cb.fn===fn){callbacks.splice(i,1);break}return this},Emitter.prototype.emit=function(event){this._callbacks=this._callbacks||{};var args=[].slice.call(arguments,1),callbacks=this._callbacks["$"+event];if(callbacks)for(var i=0,len=(callbacks=callbacks.slice(0)).length;i<len;++i)callbacks[i].apply(this,args);return this},Emitter.prototype.listeners=function(event){return this._callbacks=this._callbacks||{},this._callbacks["$"+event]||[]},Emitter.prototype.hasListeners=function(event){return!!this.listeners(event).length}},{}],8:[function(require,module,exports){!function(){"use strict";function getSqSegDist(p,p1,p2){var x=p1.x,y=p1.y,dx=p2.x-x,dy=p2.y-y;if(0!==dx||0!==dy){var t=((p.x-x)*dx+(p.y-y)*dy)/(dx*dx+dy*dy);t>1?(x=p2.x,y=p2.y):t>0&&(x+=dx*t,y+=dy*t)}return(dx=p.x-x)*dx+(dy=p.y-y)*dy}function simplifyDouglasPeucker(points,sqTolerance){var last=points.length-1,simplified=[points[0]];return function simplifyDPStep(points,first,last,sqTolerance,simplified){for(var index,maxSqDist=sqTolerance,i=first+1;i<last;i++){var sqDist=getSqSegDist(points[i],points[first],points[last]);sqDist>maxSqDist&&(index=i,maxSqDist=sqDist)}maxSqDist>sqTolerance&&(index-first>1&&simplifyDPStep(points,first,index,sqTolerance,simplified),simplified.push(points[index]),last-index>1&&simplifyDPStep(points,index,last,sqTolerance,simplified))}(points,0,last,sqTolerance,simplified),simplified.push(points[last]),simplified}function simplify(points,tolerance,highestQuality){if(points.length<=2)return points;var sqTolerance=void 0!==tolerance?tolerance*tolerance:1;return points=simplifyDouglasPeucker(points=highestQuality?points:function(points,sqTolerance){for(var point,p1,p2,dx,dy,prevPoint=points[0],newPoints=[prevPoint],i=1,len=points.length;i<len;i++)point=points[i],p2=prevPoint,dx=(p1=point).x-p2.x,dy=p1.y-p2.y,dx*dx+dy*dy>sqTolerance&&(newPoints.push(point),prevPoint=point);return prevPoint!==point&&newPoints.push(point),newPoints}(points,sqTolerance),sqTolerance)}void 0!==module?(module.exports=simplify,module.exports.default=simplify):"undefined"!=typeof self?self.simplify=simplify:window.simplify=simplify}()},{}],9:[function(require,module,exports){function Agent(){this._defaults=[]}["use","on","once","set","query","type","accept","auth","withCredentials","sortQuery","retry","ok","redirects","timeout","buffer","serialize","parse","ca","key","pfx","cert"].forEach(fn=>{Agent.prototype[fn]=function(...args){return this._defaults.push({fn:fn,args:args}),this}}),Agent.prototype._setDefaults=function(req){this._defaults.forEach(def=>{req[def.fn].apply(req,def.args)})},module.exports=Agent},{}],10:[function(require,module,exports){let root;"undefined"!=typeof window?root=window:"undefined"!=typeof self?root=self:(console.warn("Using browser-only version of superagent in non-browser environment"),root=this);const Emitter=require("component-emitter"),RequestBase=require("./request-base"),isObject=require("./is-object"),ResponseBase=require("./response-base"),Agent=require("./agent-base");function noop(){}const request=exports=module.exports=function(method,url){return"function"==typeof url?new exports.Request("GET",method).end(url):1==arguments.length?new exports.Request("GET",method):new exports.Request(method,url)};exports.Request=Request,request.getXHR=(()=>{if(!(!root.XMLHttpRequest||root.location&&"file:"==root.location.protocol&&root.ActiveXObject))return new XMLHttpRequest;try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){}throw Error("Browser-only version of superagent could not find XHR")});const trim="".trim?s=>s.trim():s=>s.replace(/(^\s*|\s*$)/g,"");function serialize(obj){if(!isObject(obj))return obj;const pairs=[];for(const key in obj)pushEncodedKeyValuePair(pairs,key,obj[key]);return pairs.join("&")}function pushEncodedKeyValuePair(pairs,key,val){if(null!=val)if(Array.isArray(val))val.forEach(v=>{pushEncodedKeyValuePair(pairs,key,v)});else if(isObject(val))for(const subkey in val)pushEncodedKeyValuePair(pairs,`${key}[${subkey}]`,val[subkey]);else pairs.push(encodeURIComponent(key)+"="+encodeURIComponent(val));else null===val&&pairs.push(encodeURIComponent(key))}function parseString(str){const obj={},pairs=str.split("&");let pair,pos;for(let i=0,len=pairs.length;i<len;++i)-1==(pos=(pair=pairs[i]).indexOf("="))?obj[decodeURIComponent(pair)]="":obj[decodeURIComponent(pair.slice(0,pos))]=decodeURIComponent(pair.slice(pos+1));return obj}function isJSON(mime){return/[\/+]json($|[^-\w])/.test(mime)}function Response(req){this.req=req,this.xhr=this.req.xhr,this.text="HEAD"!=this.req.method&&(""===this.xhr.responseType||"text"===this.xhr.responseType)||void 0===this.xhr.responseType?this.xhr.responseText:null,this.statusText=this.req.xhr.statusText;let status=this.xhr.status;1223===status&&(status=204),this._setStatusProperties(status),this.header=this.headers=function(str){const lines=str.split(/\r?\n/),fields={};let index,line,field,val;for(let i=0,len=lines.length;i<len;++i)-1!==(index=(line=lines[i]).indexOf(":"))&&(field=line.slice(0,index).toLowerCase(),val=trim(line.slice(index+1)),fields[field]=val);return fields}(this.xhr.getAllResponseHeaders()),this.header["content-type"]=this.xhr.getResponseHeader("content-type"),this._setHeaderProperties(this.header),null===this.text&&req._responseType?this.body=this.xhr.response:this.body="HEAD"!=this.req.method?this._parseBody(this.text?this.text:this.xhr.response):null}function Request(method,url){const self=this;this._query=this._query||[],this.method=method,this.url=url,this.header={},this._header={},this.on("end",()=>{let new_err,err=null,res=null;try{res=new Response(self)}catch(e){return(err=new Error("Parser is unable to parse the response")).parse=!0,err.original=e,self.xhr?(err.rawResponse=void 0===self.xhr.responseType?self.xhr.responseText:self.xhr.response,err.status=self.xhr.status?self.xhr.status:null,err.statusCode=err.status):(err.rawResponse=null,err.status=null),self.callback(err)}self.emit("response",res);try{self._isResponseOK(res)||(new_err=new Error(res.statusText||"Unsuccessful HTTP response"))}catch(custom_err){new_err=custom_err}new_err?(new_err.original=err,new_err.response=res,new_err.status=res.status,self.callback(new_err,res)):self.callback(null,res)})}function del(url,data,fn){const req=request("DELETE",url);return"function"==typeof data&&(fn=data,data=null),data&&req.send(data),fn&&req.end(fn),req}request.serializeObject=serialize,request.parseString=parseString,request.types={html:"text/html",json:"application/json",xml:"text/xml",urlencoded:"application/x-www-form-urlencoded",form:"application/x-www-form-urlencoded","form-data":"application/x-www-form-urlencoded"},request.serialize={"application/x-www-form-urlencoded":serialize,"application/json":JSON.stringify},request.parse={"application/x-www-form-urlencoded":parseString,"application/json":JSON.parse},ResponseBase(Response.prototype),Response.prototype._parseBody=function(str){let parse=request.parse[this.type];return this.req._parser?this.req._parser(this,str):(!parse&&isJSON(this.type)&&(parse=request.parse["application/json"]),parse&&str&&(str.length||str instanceof Object)?parse(str):null)},Response.prototype.toError=function(){const req=this.req,method=req.method,url=req.url,msg=`cannot ${method} ${url} (${this.status})`,err=new Error(msg);return err.status=this.status,err.method=method,err.url=url,err},request.Response=Response,Emitter(Request.prototype),RequestBase(Request.prototype),Request.prototype.type=function(type){return this.set("Content-Type",request.types[type]||type),this},Request.prototype.accept=function(type){return this.set("Accept",request.types[type]||type),this},Request.prototype.auth=function(user,pass,options){1===arguments.length&&(pass=""),"object"==typeof pass&&null!==pass&&(options=pass,pass=""),options||(options={type:"function"==typeof btoa?"basic":"auto"});return this._auth(user,pass,options,string=>{if("function"==typeof btoa)return btoa(string);throw new Error("Cannot use basic auth, btoa is not a function")})},Request.prototype.query=function(val){return"string"!=typeof val&&(val=serialize(val)),val&&this._query.push(val),this},Request.prototype.attach=function(field,file,options){if(file){if(this._data)throw Error("superagent can't mix .send() and .attach()");this._getFormData().append(field,file,options||file.name)}return this},Request.prototype._getFormData=function(){return this._formData||(this._formData=new root.FormData),this._formData},Request.prototype.callback=function(err,res){if(this._shouldRetry(err,res))return this._retry();const fn=this._callback;this.clearTimeout(),err&&(this._maxRetries&&(err.retries=this._retries-1),this.emit("error",err)),fn(err,res)},Request.prototype.crossDomainError=function(){const err=new Error("Request has been terminated\nPossible causes: the network is offline, Origin is not allowed by Access-Control-Allow-Origin, the page is being unloaded, etc.");err.crossDomain=!0,err.status=this.status,err.method=this.method,err.url=this.url,this.callback(err)},Request.prototype.buffer=Request.prototype.ca=Request.prototype.agent=function(){return console.warn("This is not supported in browser version of superagent"),this},Request.prototype.pipe=Request.prototype.write=(()=>{throw Error("Streaming is not supported in browser version of superagent")}),Request.prototype._isHost=function(obj){return obj&&"object"==typeof obj&&!Array.isArray(obj)&&"[object Object]"!==Object.prototype.toString.call(obj)},Request.prototype.end=function(fn){this._endCalled&&console.warn("Warning: .end() was called twice. This is not supported in superagent"),this._endCalled=!0,this._callback=fn||noop,this._finalizeQueryString(),this._end()},Request.prototype._end=function(){if(this._aborted)return this.callback(Error("The request has been aborted even before .end() was called"));const self=this,xhr=this.xhr=request.getXHR();let data=this._formData||this._data;this._setTimeouts(),xhr.onreadystatechange=(()=>{const readyState=xhr.readyState;if(readyState>=2&&self._responseTimeoutTimer&&clearTimeout(self._responseTimeoutTimer),4!=readyState)return;let status;try{status=xhr.status}catch(e){status=0}if(!status){if(self.timedout||self._aborted)return;return self.crossDomainError()}self.emit("end")});const handleProgress=(direction,e)=>{e.total>0&&(e.percent=e.loaded/e.total*100),e.direction=direction,self.emit("progress",e)};if(this.hasListeners("progress"))try{xhr.onprogress=handleProgress.bind(null,"download"),xhr.upload&&(xhr.upload.onprogress=handleProgress.bind(null,"upload"))}catch(e){}try{this.username&&this.password?xhr.open(this.method,this.url,!0,this.username,this.password):xhr.open(this.method,this.url,!0)}catch(err){return this.callback(err)}if(this._withCredentials&&(xhr.withCredentials=!0),!this._formData&&"GET"!=this.method&&"HEAD"!=this.method&&"string"!=typeof data&&!this._isHost(data)){const contentType=this._header["content-type"];let serialize=this._serializer||request.serialize[contentType?contentType.split(";")[0]:""];!serialize&&isJSON(contentType)&&(serialize=request.serialize["application/json"]),serialize&&(data=serialize(data))}for(const field in this.header)null!=this.header[field]&&this.header.hasOwnProperty(field)&&xhr.setRequestHeader(field,this.header[field]);this._responseType&&(xhr.responseType=this._responseType),this.emit("request",this),xhr.send(void 0!==data?data:null)},request.agent=(()=>new Agent),["GET","POST","OPTIONS","PATCH","PUT","DELETE"].forEach(method=>{Agent.prototype[method.toLowerCase()]=function(url,fn){const req=new request.Request(method,url);return this._setDefaults(req),fn&&req.end(fn),req}}),Agent.prototype.del=Agent.prototype.delete,request.get=((url,data,fn)=>{const req=request("GET",url);return"function"==typeof data&&(fn=data,data=null),data&&req.query(data),fn&&req.end(fn),req}),request.head=((url,data,fn)=>{const req=request("HEAD",url);return"function"==typeof data&&(fn=data,data=null),data&&req.query(data),fn&&req.end(fn),req}),request.options=((url,data,fn)=>{const req=request("OPTIONS",url);return"function"==typeof data&&(fn=data,data=null),data&&req.send(data),fn&&req.end(fn),req}),request.del=del,request.delete=del,request.patch=((url,data,fn)=>{const req=request("PATCH",url);return"function"==typeof data&&(fn=data,data=null),data&&req.send(data),fn&&req.end(fn),req}),request.post=((url,data,fn)=>{const req=request("POST",url);return"function"==typeof data&&(fn=data,data=null),data&&req.send(data),fn&&req.end(fn),req}),request.put=((url,data,fn)=>{const req=request("PUT",url);return"function"==typeof data&&(fn=data,data=null),data&&req.send(data),fn&&req.end(fn),req})},{"./agent-base":9,"./is-object":11,"./request-base":12,"./response-base":13,"component-emitter":7}],11:[function(require,module,exports){"use strict";module.exports=function(obj){return null!==obj&&"object"==typeof obj}},{}],12:[function(require,module,exports){"use strict";const isObject=require("./is-object");function RequestBase(obj){if(obj)return function(obj){for(const key in RequestBase.prototype)obj[key]=RequestBase.prototype[key];return obj}(obj)}module.exports=RequestBase,RequestBase.prototype.clearTimeout=function(){return clearTimeout(this._timer),clearTimeout(this._responseTimeoutTimer),delete this._timer,delete this._responseTimeoutTimer,this},RequestBase.prototype.parse=function(fn){return this._parser=fn,this},RequestBase.prototype.responseType=function(val){return this._responseType=val,this},RequestBase.prototype.serialize=function(fn){return this._serializer=fn,this},RequestBase.prototype.timeout=function(options){if(!options||"object"!=typeof options)return this._timeout=options,this._responseTimeout=0,this;for(const option in options)switch(option){case"deadline":this._timeout=options.deadline;break;case"response":this._responseTimeout=options.response;break;default:console.warn("Unknown timeout option",option)}return this},RequestBase.prototype.retry=function(count,fn){return 0!==arguments.length&&!0!==count||(count=1),count<=0&&(count=0),this._maxRetries=count,this._retries=0,this._retryCallback=fn,this};const ERROR_CODES=["ECONNRESET","ETIMEDOUT","EADDRINFO","ESOCKETTIMEDOUT"];RequestBase.prototype._shouldRetry=function(err,res){if(!this._maxRetries||this._retries++>=this._maxRetries)return!1;if(this._retryCallback)try{const override=this._retryCallback(err,res);if(!0===override)return!0;if(!1===override)return!1}catch(e){console.error(e)}if(res&&res.status&&res.status>=500&&501!=res.status)return!0;if(err){if(err.code&&~ERROR_CODES.indexOf(err.code))return!0;if(err.timeout&&"ECONNABORTED"==err.code)return!0;if(err.crossDomain)return!0}return!1},RequestBase.prototype._retry=function(){return this.clearTimeout(),this.req&&(this.req=null,this.req=this.request()),this._aborted=!1,this.timedout=!1,this._end()},RequestBase.prototype.then=function(resolve,reject){if(!this._fullfilledPromise){const self=this;this._endCalled&&console.warn("Warning: superagent request was sent twice, because both .end() and .then() were called. Never call .end() if you use promises"),this._fullfilledPromise=new Promise((innerResolve,innerReject)=>{self.on("error",innerReject),self.on("abort",()=>{const err=new Error("Aborted");err.code="ABORTED",err.status=this.status,err.method=this.method,err.url=this.url,innerReject(err)}),self.end((err,res)=>{err?innerReject(err):innerResolve(res)})})}return this._fullfilledPromise.then(resolve,reject)},RequestBase.prototype.catch=function(cb){return this.then(void 0,cb)},RequestBase.prototype.use=function(fn){return fn(this),this},RequestBase.prototype.ok=function(cb){if("function"!=typeof cb)throw Error("Callback required");return this._okCallback=cb,this},RequestBase.prototype._isResponseOK=function(res){return!!res&&(this._okCallback?this._okCallback(res):res.status>=200&&res.status<300)},RequestBase.prototype.get=function(field){return this._header[field.toLowerCase()]},RequestBase.prototype.getHeader=RequestBase.prototype.get,RequestBase.prototype.set=function(field,val){if(isObject(field)){for(const key in field)this.set(key,field[key]);return this}return this._header[field.toLowerCase()]=val,this.header[field]=val,this},RequestBase.prototype.unset=function(field){return delete this._header[field.toLowerCase()],delete this.header[field],this},RequestBase.prototype.field=function(name,val){if(null===name||void 0===name)throw new Error(".field(name, val) name can not be empty");if(this._data)throw new Error(".field() can't be used if .send() is used. Please use only .send() or only .field() & .attach()");if(isObject(name)){for(const key in name)this.field(key,name[key]);return this}if(Array.isArray(val)){for(const i in val)this.field(name,val[i]);return this}if(null===val||void 0===val)throw new Error(".field(name, val) val can not be empty");return"boolean"==typeof val&&(val=""+val),this._getFormData().append(name,val),this},RequestBase.prototype.abort=function(){return this._aborted?this:(this._aborted=!0,this.xhr&&this.xhr.abort(),this.req&&this.req.abort(),this.clearTimeout(),this.emit("abort"),this)},RequestBase.prototype._auth=function(user,pass,options,base64Encoder){switch(options.type){case"basic":this.set("Authorization",`Basic ${base64Encoder(`${user}:${pass}`)}`);break;case"auto":this.username=user,this.password=pass;break;case"bearer":this.set("Authorization",`Bearer ${user}`)}return this},RequestBase.prototype.withCredentials=function(on){return void 0==on&&(on=!0),this._withCredentials=on,this},RequestBase.prototype.redirects=function(n){return this._maxRedirects=n,this},RequestBase.prototype.maxResponseSize=function(n){if("number"!=typeof n)throw TypeError("Invalid argument");return this._maxResponseSize=n,this},RequestBase.prototype.toJSON=function(){return{method:this.method,url:this.url,data:this._data,headers:this._header}},RequestBase.prototype.send=function(data){const isObj=isObject(data);let type=this._header["content-type"];if(this._formData)throw new Error(".send() can't be used if .attach() or .field() is used. Please use only .send() or only .field() & .attach()");if(isObj&&!this._data)Array.isArray(data)?this._data=[]:this._isHost(data)||(this._data={});else if(data&&this._data&&this._isHost(this._data))throw Error("Can't merge these send calls");if(isObj&&isObject(this._data))for(const key in data)this._data[key]=data[key];else"string"==typeof data?(type||this.type("form"),type=this._header["content-type"],this._data="application/x-www-form-urlencoded"==type?this._data?`${this._data}&${data}`:data:(this._data||"")+data):this._data=data;return!isObj||this._isHost(data)?this:(type||this.type("json"),this)},RequestBase.prototype.sortQuery=function(sort){return this._sort=void 0===sort||sort,this},RequestBase.prototype._finalizeQueryString=function(){const query=this._query.join("&");if(query&&(this.url+=(this.url.indexOf("?")>=0?"&":"?")+query),this._query.length=0,this._sort){const index=this.url.indexOf("?");if(index>=0){const queryArr=this.url.substring(index+1).split("&");"function"==typeof this._sort?queryArr.sort(this._sort):queryArr.sort(),this.url=this.url.substring(0,index)+"?"+queryArr.join("&")}}},RequestBase.prototype._appendQueryString=(()=>{console.trace("Unsupported")}),RequestBase.prototype._timeoutError=function(reason,timeout,errno){if(this._aborted)return;const err=new Error(`${reason+timeout}ms exceeded`);err.timeout=timeout,err.code="ECONNABORTED",err.errno=errno,this.timedout=!0,this.abort(),this.callback(err)},RequestBase.prototype._setTimeouts=function(){const self=this;this._timeout&&!this._timer&&(this._timer=setTimeout(()=>{self._timeoutError("Timeout of ",self._timeout,"ETIME")},this._timeout)),this._responseTimeout&&!this._responseTimeoutTimer&&(this._responseTimeoutTimer=setTimeout(()=>{self._timeoutError("Response timeout of ",self._responseTimeout,"ETIMEDOUT")},this._responseTimeout))}},{"./is-object":11}],13:[function(require,module,exports){"use strict";const utils=require("./utils");function ResponseBase(obj){if(obj)return function(obj){for(const key in ResponseBase.prototype)obj[key]=ResponseBase.prototype[key];return obj}(obj)}module.exports=ResponseBase,ResponseBase.prototype.get=function(field){return this.header[field.toLowerCase()]},ResponseBase.prototype._setHeaderProperties=function(header){const ct=header["content-type"]||"";this.type=utils.type(ct);const params=utils.params(ct);for(const key in params)this[key]=params[key];this.links={};try{header.link&&(this.links=utils.parseLinks(header.link))}catch(err){}},ResponseBase.prototype._setStatusProperties=function(status){const type=status/100|0;this.status=this.statusCode=status,this.statusType=type,this.info=1==type,this.ok=2==type,this.redirect=3==type,this.clientError=4==type,this.serverError=5==type,this.error=(4==type||5==type)&&this.toError(),this.created=201==status,this.accepted=202==status,this.noContent=204==status,this.badRequest=400==status,this.unauthorized=401==status,this.notAcceptable=406==status,this.forbidden=403==status,this.notFound=404==status,this.unprocessableEntity=422==status}},{"./utils":14}],14:[function(require,module,exports){"use strict";exports.type=(str=>str.split(/ *; */).shift()),exports.params=(str=>str.split(/ *; */).reduce((obj,str)=>{const parts=str.split(/ *= */),key=parts.shift(),val=parts.shift();return key&&val&&(obj[key]=val),obj},{})),exports.parseLinks=(str=>str.split(/ *, */).reduce((obj,str)=>{const parts=str.split(/ *; */),url=parts[0].slice(1,-1);return obj[parts[1].split(/ *= */)[1].slice(1,-1)]=url,obj},{})),exports.cleanHeader=((header,changesOrigin)=>(delete header["content-type"],delete header["content-length"],delete header["transfer-encoding"],delete header.host,changesOrigin&&(delete header.authorization,delete header.cookie),header))},{}],15:[function(require,module,exports){"use strict";const cm=require("./common.js");module.exports={placeAutoSuggest:function(opt){const params=cm.addCredentials({at:opt.center[0]+","+opt.center[1],q:opt.search}),url=cm.buildUrl("places","api.here.com/places/v1/autosuggest");return cm.hereRest(url,params,"get",!1).then(res=>res.body.results.filter(place=>place.vicinity).map(place=>({title:place.title,value:place.title+", "+place.vicinity.replace(/<br\/>/g,", "),coord:place.position,res:place})))}}},{"./common.js":3}],16:[function(require,module,exports){"use strict";const cm=require("./common.js");function matrix(source,dest,opt){const params=cm.addCredentials({mode:"fastest;car;traffic:enabled",summaryAttributes:"tt,di"},opt);Array.isArray(source[0])||(source=[source]),source.forEach((coord,i)=>{params["start"+i]=coord[0]+","+coord[1]}),Array.isArray(dest[0])||(dest=[dest]),dest.forEach((coord,i)=>{params["destination"+i]=coord[0]+","+coord[1]});const url=cm.buildUrl("matrix.route","api.here.com/routing/7.2/calculatematrix.json");return cm.hereRest(url,params,"post").then(res=>({entries:res.body.response.matrixEntry,body:res.body}))}module.exports={matrix:matrix,route:function(source,dest,opt){const params=cm.addCredentials({mode:"fastest;car;traffic:disabled",representation:"linkPaging",routeattributes:"waypoints,summary,shape",maneuverattributes:"direction,action"},opt);let id=0;if(Array.isArray(source[0]))for(var i=0;i<source.length;i++){let coord=source[i];params["waypoint"+id++]=coord[0]+","+coord[1]}else params["waypoint"+id++]=source[0]+","+source[1];if(Array.isArray(dest[0]))for(let i=0;i<dest.length;i++){let coord=dest[i];params["waypoint"+id++]=coord[0]+","+coord[1]}else params["waypoint"+id++]=dest[0]+","+dest[1];const url=cm.buildUrl("route","api.here.com/routing/7.2/calculateroute.json");return cm.hereRest(url,params,"post").then(res=>{const route=res.body.response.route[0];return{summary:route.summary,coords:route.shape.map(latlng=>latlng.split(",")),route:route,body:res.body}})},isoline:function(opt){const params=cm.addCredentials({start:null,destination:null,rangeType:"time",range:null,linkattributes:"sh",mode:"fastest;car;traffic:disabled"},opt);if(params.start&&(params.start="geo!"+params.start[0]+","+params.start[1]),params.destination&&(params.destination="geo!"+params.destination[0]+","+params.destination[1]),!params.start&&!params.destination)throw new Error("Isoline routing : missing start or destination");if(!params.range)throw new Error("Isoline routing : missing range");const url=cm.buildUrl("isoline.route","api.here.com/routing/7.2/calculateisoline.json");return cm.hereRest(url,params,"post").then(res=>({poly:res.body.response.isoline[0].component[0].shape.map(point=>point.split(",")),body:res.body}))},detour:async function(start,stop,waypoints){return new Promise(async(resolve,reject)=>{if(!start)return reject("missing start point");if(!stop)return reject("missing stop point");if(!waypoints)return reject("missing waypoints");if(!Array.isArray)return reject("waypoints should be an array");let res={reference:{},waypoints:[]},dest=[stop];waypoints.forEach(waypoint=>{dest.push(waypoint),res.waypoints.push({coord:waypoint})});let p1=matrix(start,dest,{mode:"fastest;car;traffic:disabled"});dest[0]=start;let p2=matrix(dest,stop,{mode:"fastest;car;traffic:disabled"});const result=await Promise.all([p1,p2]);let entries=result[0].entries,dist=entries[0].summary.distance,time=entries[0].summary.travelTime;return res.reference.start=start,res.reference.stop=stop,res.reference.distance=dist,res.reference.time=time,entries.forEach((entry,i)=>{if(0==i)return;if("failed"==entry.status)return;let id=entry.destinationIndex,dist=entry.summary.distance,time=entry.summary.travelTime;res.waypoints[id-1].distA=dist,res.waypoints[id-1].timeA=time}),entries=result[1].entries,res.reference.distance2=entries[0].summary.distance,res.reference.time2=entries[0].summary.travelTime,entries.forEach((entry,i)=>{if(0==i)return;if("failed"==entry.status)return;let id=entry.startIndex,dist=entry.summary.distance,time=entry.summary.travelTime;res.waypoints[id-1].distB=dist,res.waypoints[id-1].timeB=time}),resolve(res)})}}},{"./common.js":3}],17:[function(require,module,exports){"use strict";const hm=require("./map.js"),simplify=require("simplify-js");let _touchOffset=null,_touchCoords=null,_touchPolyline=null,_touchLayer=null,_touchCallback=null,_map=null,_behavior=null,_behaviorEnable=!0;function behaviorEnable(onoff){_behaviorEnable&&!onoff&&(_behavior.disable(),_behaviorEnable=!1),!_behaviorEnable&&onoff&&(_behavior.enable(),_behaviorEnable=!0)}module.exports={touch:function(onoff,options){_map=hm.getMap(),_behavior=hm.getBehavior();let elmt=document.getElementById(hm.getMapHtmlItem()),bb=elmt.getBoundingClientRect();_touchOffset={left:bb.x,top:bb.y};const settings={callback:null,layer:"_touch",keep:!1,style:{lineWidth:5,strokeColor:"rgba(255, 0, 0, 0.7)"},arrows:{fillColor:"white",frequency:5,width:1,length:2},tolerance:4};Object.assign(settings,options),(_touchLayer=hm.layerFind(settings.layer))||(_touchLayer=hm.layerCreate(settings.layer)),onoff&&(_touchCallback=function(e){let simplified,touchobj=e.changedTouches[0];if(e.touches.length>=2)behaviorEnable(!0);else switch("touchmove"==e.type&&behaviorEnable(!1),e.type){case"touchstart":_touchCoords=[];break;case"touchmove":if(_touchCoords.push({x:touchobj.clientX-_touchOffset.left,y:touchobj.clientY-_touchOffset.top}),_touchCoords.length<2)return;var lineString=new H.geo.LineString;_touchCoords.forEach(c=>{let coord=_map.screenToGeo(c.x,c.y);lineString.pushLatLngAlt(coord.lat,coord.lng,0)}),_touchPolyline?_touchPolyline.setGeometry(lineString):(_touchPolyline=new H.map.Polyline(lineString,{style:settings.style,arrows:settings.arrows}),_touchLayer.addObject(_touchPolyline));break;case"touchend":if(_touchCoords.length<2)return;if(simplified=_touchCoords,settings.callback){settings.tolerance>0&&(simplified=simplify(_touchCoords,settings.tolerance,!1)),simplified.length<1&&(simplified=_touchCoords);let coords=simplified.map(coord=>{let latlng=_map.screenToGeo(coord.x,coord.y);return[latlng.lat,latlng.lng]});_touchPolyline&&!settings.keep&&_touchLayer.removeObject(_touchPolyline),_touchPolyline=null,behaviorEnable(!0),settings.callback(coords)}}}),onoff?(elmt.addEventListener("touchstart",_touchCallback),elmt.addEventListener("touchmove",_touchCallback),elmt.addEventListener("touchend",_touchCallback)):(elmt.removeEventListener("touchstart",_touchCallback),elmt.removeEventListener("touchmove",_touchCallback),elmt.removeEventListener("touchend",_touchCallback),_touchPolyline&&_touchLayer.removeObject(_touchPolyline),_touchLayer=null,_touchPolyline=null,_touchCoords=null,behaviorEnable(!0))}}},{"./map.js":6,"simplify-js":8}]},{},[3,5,6,16,4,2,17,15])(17)});